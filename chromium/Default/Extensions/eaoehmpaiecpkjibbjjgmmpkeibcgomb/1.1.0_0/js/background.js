function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}String.prototype.htmlSymDecode=function(){var e=document.createElement("div");return e.innerHTML=this,e.innerText};var Background=function(){"use strict";function e(){_classCallCheck(this,e),this.videoFormats=["mp4","mov","flv","webm","3gp","ogg","m4a","mp3","wav","bin"],this.tabsData={},this.initListeners()}return _createClass(e,[{key:"initListeners",value:function(){var n=this;chrome.runtime.onInstalled.addListener(function(e){"install"==e.reason&&(chrome.storage.local.set({total_number_of_downloads:0}),n.installScript())}),chrome.tabs.onUpdated.addListener(function(e,t,a){t.url&&(n.resetVideoLinks(e),n.updateExtensionIcon(e),chrome.tabs.sendMessage(e,{message:"url-updated",url:t.url}))}),chrome.tabs.onRemoved.addListener(function(e,t,a){n.tabsData[e]&&n.resetVideoLinks(e)}),chrome.webRequest.onHeadersReceived.addListener(function(t){var a;t.responseHeaders&&t.url&&0<t.tabId&&((a=n.getVideoTypeFromRes(t.responseHeaders))&&chrome.tabs.get(t.tabId,function(e){e.url.indexOf("youtube.com")||n.addVideoLinkToTab({url:t.url,size:n.getVideoSize(t.responseHeaders),fileName:n.sanitizeFilename(e.title),extension:"."+a},t.tabId,e.url)}))},{urls:["<all_urls>"]},["blocking","responseHeaders"]),chrome.runtime.onMessage.addListener(function(e,t,a){switch(e.message){case"add-video-links":n.addVideoLinks(e.videoLinks,t.tab.id,t.tab.url);break;case"ajax-get":return n.ajaxGet(e.url,a),!0;case"get-video-links":a(n.getVideoLinksForTab(e.tabId));break;case"download-video-link":n.downloadVideoLink(e.url,e.fileName)}})}},{key:"installScript",value:function(){chrome.windows.getAll({populate:!0},function(e){var t,a,n,i=chrome.runtime.getManifest().content_scripts[0].js;for(t in e){var o=e[t].tabs;for(a in o)(function(){var e=o[a];if(e.url.match(/chrome(|[\S]+):\/\//gi))return;var t;for(n in i)t=void 0,t=i[n],chrome.tabs.executeScript(e.id,{file:t},function(e){chrome.runtime.lastError})})()}})}},{key:"setInstallUrl",value:function(){chrome.runtime.setUninstallURL&&chrome.runtime.setUninstallURL("http://smarturl.it/vdm-uninstall"),chrome.runtime.onInstalled.addListener(function(e){("install"==e.reason||"update"==e.reason)&&chrome.tabs.create({url:"http://smarturl.it/vdm-install"})})}},{key:"isVideoUrl",value:function(t){var a=!1;return this.videoFormats.some(function(e){if(-1!=t.indexOf(e))return a=!0}),a}},{key:"getVideoTypeFromRes",value:function(e){var a=this,n=null;return e.some(function(t){if("Content-Type"==t.name)return a.videoFormats.forEach(function(e){if(-1!=t.value.indexOf(e)&&!/^audio/i.test(t.value))return n=e,!0}),!0}),n}},{key:"getNewTabObject",value:function(){return{videoLinks:[],url:""}}},{key:"getVideoSize",value:function(e){var t=0;return e.forEach(function(e){"Content-Length"==e.name&&(t=parseInt(e.value))}),t}},{key:"getVideoDataFromServer",value:function(e,t){var a=new XMLHttpRequest;a.onreadystatechange=function(){2===a.readyState&&(t({mime:a.getResponseHeader("Content-Type"),size:a.getResponseHeader("Content-Length")}),a.abort())},a.open("Get",e),a.send()}},{key:"sanitizeFilename",value:function(e){return e.htmlSymDecode().replace(/^\./,"_").replace(/[\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200b-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,"").replace(/&quot;/g,"").replace(/&amp;/g,"&").replace(/[\\/:*?<>|~â†µ"\t]/g,"_").slice(0,100)}},{key:"isVideoLinkAlreadyAdded",value:function(e,t){var a=!1;return e.some(function(e){if(e.url===t)return a=!0}),a}},{key:"setBadge",value:function(e,t){e=e?e+"":"";chrome.browserAction.setBadgeBackgroundColor({color:[16,201,33,100],tabId:t}),chrome.browserAction.setBadgeText({text:e,tabId:t})}},{key:"updateExtensionIcon",value:function(e){this.tabsData[e]&&0<this.tabsData[e].videoLinks.length?this.setBadge(this.tabsData[e].videoLinks.length,e):this.setBadge(0,e)}},{key:"addVideoLinkToTabFinalStep",value:function(e,t){!this.isVideoLinkAlreadyAdded(this.tabsData[e].videoLinks,t.url)&&1024<t.size&&this.isVideoUrl(t.url)&&(this.tabsData[e].videoLinks.push(t),this.updateExtensionIcon(e))}},{key:"addVideoLinkToTab",value:function(t,a,e){var n=this;this.tabsData[a]||(this.tabsData[a]=this.getNewTabObject()),e!=this.tabsData[a].url&&(this.tabsData[a].videoLinks=[],this.tabsData[a].url=e),t.size?this.addVideoLinkToTabFinalStep(a,t):this.getVideoDataFromServer(t.url,function(e){t.size=e.size,n.addVideoLinkToTabFinalStep(a,t)})}},{key:"resetVideoLinks",value:function(e){delete this.tabsData[e]}},{key:"addVideoLinks",value:function(e,t,a){var n=this;this.tabsData[t]||(this.tabsData[t]=this.getNewTabObject()),a!=this.tabsData[t].url&&(this.tabsData[t].videoLinks=[],this.tabsData[t].url=a),e.forEach(function(e){e.fileName=n.sanitizeFilename(e.fileName),n.addVideoLinkToTab(e,t,a)})}},{key:"getVideoLinksForTab",value:function(e){return this.tabsData[e]?this.tabsData[e]:{}}},{key:"incrementDownloadCount",value:function(){chrome.storage.local.get(["total_number_of_downloads"],function(e){var t=e.total_number_of_downloads+1;chrome.storage.local.set({total_number_of_downloads:t}),3==t&&confirm("You have downloaded multiple videos with Video Downloader professional. Please share your experience with others and make a review for us.")&&chrome.tabs.create({url:"http://smarturl.it/vdm-reviews",selected:!0},function(e){}),7==t&&confirm("if you like what we do and can support our work, please make a donation so we can keep on making it even better.")&&chrome.tabs.create({url:"http://smarturl.it/vdm-contribute",selected:!0},function(e){})})}},{key:"downloadVideoLink",value:function(e,t){chrome.downloads.download({url:e,filename:t})}},{key:"showYoutubeWarning",value:function(){chrome.tabs.create({url:"http://smarturl.it/youtube-alert",selected:!0},function(e){})}},{key:"ajaxGet",value:function(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.onload=function(){return t(a.responseText)},a.send()}}]),e}(),bg=new Background;